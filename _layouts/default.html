<!DOCTYPE html>
<html>

  {% include head.html %}

  <body class="{% if page.layout == 'homelay' %}homelay{% else %}other-page{% endif %}">
  <!-- Google Tag Manager (noscript): moved here per Google‚Äôs guidance -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id={{ site.google_tag_manager }}"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>

<script>
// Theme initializer
(function(){
  try {
  var saved = localStorage.getItem('theme'); // 'dark'|'light' or null
  // Default to dark when there's no saved preference
  var theme = saved || 'dark';

    // Apply theme
    if (theme === 'dark') document.body.setAttribute('data-theme', 'dark');
    else document.body.removeAttribute('data-theme');

    // Update toggle icon
    var icon = document.getElementById('theme-icon');
    if (icon) icon.textContent = (theme === 'dark') ? '‚òÄÔ∏è' : 'üåô';
  } catch (e) {
    /* fail silently */
  }
})();
</script>

  <!-- Theme Toggle Button -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
    <span id="theme-icon">üåô</span>
  </button>

  <header>
    {% include header.html %}
  </header>

  <main>
    <div class="container-fluid">
      <div class="row">
        {% if page.layout == 'homelay' or page.no_sidebar or page.url == '/about/' %}
          {{ content }}
        {% else %}
          <div id="maincol" class="col-lg-9 col-md-8 col-sm-12">
            {{ content }}
          </div>
          <div id="rightbanner" class="col-lg-3 col-md-4 col-sm-12">
            {% include sidebar.html %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Subtle Scroll Hint -->
    <div class="scroll-hint" id="scrollHint">
      <div class="scroll-arrow"></div>
      <span class="scroll-text" style="margin-left: 8px;">Scroll down</span>
    </div>
  </main>

  {% include footer.html %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var right = document.getElementById('rightbanner');
    if (!right) return;
    right.style.cursor = 'pointer';
    right.addEventListener('click', function(e) {
      var node = e.target;
      while (node && node !== right) {
        if (node.tagName && node.tagName.toLowerCase() === 'a') return;
        node = node.parentNode;
      }
      window.location.href = '{{ site.url }}{{ site.baseurl }}/about';
    });
  });
</script>

<script>
  // Theme toggle functionality
  function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('theme-icon');
    if (body.getAttribute('data-theme') === 'dark') {
      body.removeAttribute('data-theme');
      themeIcon.textContent = 'üåô';
      localStorage.setItem('theme', 'light');
    } else {
      body.setAttribute('data-theme', 'dark');
      themeIcon.textContent = '‚òÄÔ∏è';
      localStorage.setItem('theme', 'dark');
    }
  }

  // Debounce
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func(...args), wait);
    };
  }

  // Scroll hint handler
  function handleScrollHint() {
    const hint = document.getElementById('scrollHint');
    const footer = document.getElementById('footer');
    const main = document.querySelector('main');
    if (!hint || !footer) return;

    hint.style.position = 'fixed';
    hint.style.left = '50%';
    hint.style.transform = 'translateX(-50%)';
    hint.style.zIndex = '1100';

    let scrollEl;
    if (main && main.scrollHeight > main.clientHeight + 10) {
      scrollEl = main;
    } else {
      scrollEl = document.documentElement;
    }

    const isScrollable = scrollEl.scrollHeight > scrollEl.clientHeight + 40;
    const scrollTop = scrollEl.scrollTop || document.documentElement.scrollTop || document.body.scrollTop;
    const isAtTop = scrollTop < 50;

    const shouldShow = isScrollable && isAtTop;
    hint.style.opacity = shouldShow ? '0.85' : '0';
  }

  // DOMContentLoaded block
  document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('theme');
    const icon = document.getElementById('theme-icon');
    // Only override the initial theme if the user has an explicit saved preference
    if (saved === 'dark') {
      document.body.setAttribute('data-theme', 'dark');
      if (icon) icon.textContent = '‚òÄÔ∏è';
    } else if (saved === 'light') {
      document.body.removeAttribute('data-theme');
      if (icon) icon.textContent = 'üåô';
    } else {
      // no saved preference: keep whatever the inline initializer applied (now defaults to dark)
      if (icon) {
        icon.textContent = (document.body.getAttribute('data-theme') === 'dark') ? '‚òÄÔ∏è' : 'üåô';
      }
    }

    const container = document.querySelector('main');
    const onScroll = debounce(handleScrollHint, 16);
    const onResize = debounce(() => {
      handleScrollHint();
      syncFooterBehavior();
    }, 100);

    setTimeout(() => { handleScrollHint(); syncFooterBehavior(); }, 120);

    if (container) container.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);
    window.addEventListener('load', () => { handleScrollHint(); syncFooterBehavior(); });

    const observer = new MutationObserver(debounce(() => {
      handleScrollHint();
      syncFooterBehavior();
    }, 200));

    if (container) observer.observe(container, { childList: true, subtree: true });
    const footerEl = document.getElementById('footer');
    if (footerEl) observer.observe(footerEl, { childList: true, subtree: true });
  });
</script>

  <script>
    function syncFooterBehavior() {
      const body = document.body;
      const footer = document.getElementById('footer');
      const header = document.querySelector('header');
      if (!footer || !body) return;

      const footerH = footer.offsetHeight || 0;
      const headerH = header ? header.offsetHeight : (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 0);
      const viewport = window.innerHeight || document.documentElement.clientHeight;

      const main = document.querySelector('main');
      const mainContentH = main ? main.scrollHeight : Math.max(document.body.scrollHeight - headerH - footerH, 0);

      const totalHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);

      let isShort = (mainContentH + headerH + footerH <= viewport + 2);

      const mainIsScrollable = main ? (main.scrollHeight > main.clientHeight + 8) : false;
      if (!isShort && totalHeight > viewport + 6 && !mainIsScrollable && (mainContentH <= (viewport - headerH - footerH + 8))) {
        isShort = true;
      }

      if (isShort) {
        if (!body.classList.contains('page-short')) body.classList.add('page-short');
        footer.classList.add('page-short');
      } else {
        body.classList.remove('page-short');
        footer.classList.remove('page-short');
      }

      document.documentElement.style.setProperty('--footer-height', footerH + 'px');
      console.log('syncFooterBehavior', { viewport, headerH, footerH, mainContentH, totalHeight, mainIsScrollable, isShort });
    }

    function syncHeaderHeightVar() {
      const header = document.querySelector('header');
      const h = header ? Math.ceil(header.getBoundingClientRect().height) : 64;
      document.documentElement.style.setProperty('--header-height', h + 'px');
    }

    try { syncFooterBehavior(); } catch(e) {}
    window.addEventListener('resize', () => { syncHeaderHeightVar(); }, { passive: true });
    window.addEventListener('load', () => { syncHeaderHeightVar(); }, { once: true });
  </script>

  <script>
  (function () {
    var nav = document.getElementById('navbarColor02');
    if (!nav || !window.jQuery) return;
    jQuery(nav).on('shown.bs.collapse hidden.bs.collapse', function () {
      try {
        syncHeaderHeightVar();
        handleScrollHint();
        syncFooterBehavior();
      } catch (e) {}
    });
  })();
  </script>

  <!-- Centralized scripts -->
  <script src="{{ "/assets/javascript/bootstrap/jquery.min.js" | relative_url }}"></script>
  <script src="{{ "/assets/javascript/bootstrap/bootstrap.bundle.min.js" | relative_url }}"></script>
  <script>
    (function() {
      var pinned = false;
      var debounce = function(fn, wait){ var t; return function(){ clearTimeout(t); t = setTimeout(fn, wait||80); }; };

      function getHeaderHeight() {
        var header = document.querySelector('header');
        var cssH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 0;
        if (header && header.offsetHeight) return Math.max(cssH, header.offsetHeight);
        return cssH || 64;
      }

      function pinSidebarIfNeeded() {
        var breakpoint = 992;
        var wb = window.innerWidth || document.documentElement.clientWidth;
        var rb = document.getElementById('rightbanner');
        if (!rb) return;
    var card = rb; // rename: card -> rb (the column)
        if (!card) return;

        // Small screens: unpin and restore flow
        if (wb < breakpoint) {
          if (pinned) {
            card.classList.remove('fixed-side-card');
            card.style.left = '';
            card.style.top = '';
            card.style.width = '';
            card.style.visibility = '';
            card.removeAttribute('data-pinned');
            pinned = false;
          }
          return;
        }

    rb.style.visibility = 'hidden';

        var rect = rb.getBoundingClientRect();
    var left = rect.left;
    var width = rect.width;

        // Use header height as the stable top anchor so the card doesn't jump when images load
        var headerH = getHeaderHeight();
        var top = Math.max(12, headerH + 8); 
    rb.classList.add('fixed-rightbanner');
    rb.style.left = left + 'px';
    rb.style.top = top + 'px';
    rb.style.width = width + 'px';
    rb.setAttribute('data-pinned', 'true');
    rb.style.visibility = 'visible';
        pinned = true;
      }

      var debounced = debounce(pinSidebarIfNeeded, 120);
      window.addEventListener('resize', debounced, { passive: true });
      window.addEventListener('orientationchange', debounced);
      window.addEventListener('load', function(){ setTimeout(pinSidebarIfNeeded, 50); });
      setTimeout(pinSidebarIfNeeded, 260);

      try {
        var obs = new MutationObserver(debounce(pinSidebarIfNeeded, 140));
        obs.observe(document.body, { childList: true, subtree: true });
      } catch(e) {}
    })();
  </script>

  </body>
</html>
